<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWGOH TB Performance Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <style>
        body { background-color: #f0f2f5; padding: 20px; font-family: 'Inter', sans-serif; }
        .header-card { background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d); color: white; padding: 30px; border-radius: 15px; margin-bottom: 25px; }
        .stat-card, .table-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 25px; }
        #statsTable thead th { background-color: #2c3e50; color: white; }
        .expand-btn { cursor: pointer; color: #1a2a6c; font-weight: bold; width: 30px; text-align: center; }
        .phase-box { border: 1px solid #ddd; padding: 10px; margin: 5px; border-radius: 5px; min-width: 140px; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="header-card d-flex justify-content-between align-items-center flex-wrap">
        <div>
            <h1 class="fw-bold mb-1">Guild TB Dashboard</h1>
            <p class="mb-0 opacity-75" id="status">Loading...</p>
        </div>
        <div class="bg-white p-3 rounded text-dark shadow-sm">
            <label class="small fw-bold d-block mb-1 text-muted text-uppercase">Select TB Date</label>
            <select id="dateSelector" class="form-select border-0 bg-light" onchange="loadCsvData(this.value)"></select>
        </div>
    </div>

    <div class="stat-card">
        <h5 class="fw-bold">Combat Wave Leaders (Top 10)</h5>
        <div style="height: 300px;"><canvas id="guildChart"></canvas></div>
    </div>

    <div class="table-card">
        <table id="statsTable" class="table table-hover align-middle" style="width:100%">
            <thead>
                <tr>
                    <th></th> <th>Player Name</th>
                    <th>Total Points</th>
                    <th>Total Waves</th>
                    <th>Avg Waves</th>
                    <th>Platoons</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let dataTable;
    let mainChart;

    // --- CONFIGURATION ---
    const GITHUB_USER = "thebootycheeks";
    const GITHUB_REPO = "cb";
    const FOLDER_PATH = "tb"; // The folder where your CSVs are stored

    async function scanForFiles() {
        const selector = document.getElementById('dateSelector');
        const status = document.getElementById('status');
        
        try {
            // This URL fetches the list of files directly from the GitHub API
            const apiUrl = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${FOLDER_PATH}`;
            
            const response = await fetch(apiUrl);
            
            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }

            const files = await response.json();
            
            // Filter: Only grab files that look like 'tb_2025-12-28.csv'
            const csvFiles = files
                .filter(file => file.name.startsWith('tb_') && file.name.endsWith('.csv'))
                .map(file => file.name);

            if (csvFiles.length > 0) {
                // Sort them so the newest date is at the top
                csvFiles.sort().reverse();

                selector.innerHTML = ""; // Clear the dropdown
                csvFiles.forEach((fileName, index) => {
                    // Extract the date part for the label
                    const displayDate = fileName.replace('tb_', '').replace('.csv', '');
                    const label = index === 0 ? `${displayDate} (Latest)` : displayDate;
                    selector.add(new Option(label, fileName));
                });

                // Load the first (latest) file automatically
                loadCsvData(csvFiles[0]);
            } else {
                status.innerText = "No matching CSV files found in the /tb folder.";
            }
        } catch (error) {
            status.innerText = "Error: Could not list files. (Make sure repo is public)";
            console.error("Fetch error:", error);
            
            // EMERGENCY FALLBACK: Just load the one file we know exists
            selector.add(new Option("2025-12-28 (Manual)", "tb_2025-12-28.csv"));
            loadCsvData("tb_2025-12-28.csv");
        }
    }

    function loadCsvData(filename) {
        document.getElementById('status').innerText = "Loading " + filename + "...";
        
        // Since the HTML is likely in the same folder as the CSVs, 
        // we just use the filename directly.
        Papa.parse(filename, {
            download: true,
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: function(results) {
                if (results.data && results.data.length > 0) {
                    processAndRender(results.data, filename);
                } else {
                    document.getElementById('status').innerText = "File is empty.";
                }
            },
            error: function() {
                document.getElementById('status').innerText = "Error parsing file.";
            }
        });
    }

    // ... (Keep your processAndRender, renderMainChart, and formatDetails from the previous version)
    
    // Start the scan
    scanForFiles();
</script>
</body>
</html>
