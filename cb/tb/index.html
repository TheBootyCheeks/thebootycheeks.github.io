<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWGOH TB Performance Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <style>
        body { background-color: #f0f2f5; padding: 20px; font-family: 'Inter', sans-serif; }
        .header-card { background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d); color: white; padding: 30px; border-radius: 15px; margin-bottom: 25px; }
        .stat-card, .table-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 25px; }
        #statsTable thead th { background-color: #2c3e50; color: white; }
        .expand-btn { cursor: pointer; color: #1a2a6c; font-weight: bold; width: 30px; text-align: center; }
        .phase-box { border: 1px solid #ddd; padding: 10px; margin: 5px; border-radius: 5px; min-width: 140px; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="header-card d-flex justify-content-between align-items-center flex-wrap">
        <div>
            <h1 class="fw-bold mb-1">Guild TB Dashboard</h1>
            <p class="mb-0 opacity-75" id="status">Loading...</p>
        </div>
        <div class="bg-white p-3 rounded text-dark shadow-sm">
            <label class="small fw-bold d-block mb-1 text-muted text-uppercase">Select TB Date</label>
            <select id="dateSelector" class="form-select border-0 bg-light" onchange="loadCsvData(this.value)"></select>
        </div>
    </div>

    <div class="stat-card">
        <h5 class="fw-bold">Combat Wave Leaders (Top 10)</h5>
        <div style="height: 300px;"><canvas id="guildChart"></canvas></div>
    </div>

    <div class="table-card">
        <table id="statsTable" class="table table-hover align-middle" style="width:100%">
            <thead>
                <tr>
                    <th></th> <th>Player Name</th>
                    <th>Total Points</th>
                    <th>Total Waves</th>
                    <th>Avg Waves</th>
                    <th>Platoons</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let dataTable;
    let mainChart;

    async function scanForFiles() {
        const selector = document.getElementById('dateSelector');
        const status = document.getElementById('status');
        status.innerText = "Scanning for files...";

        // 1. Setup the scanner to look for Sundays and Saturdays
        const potentialFiles = [];
        
        // Start from today
        let d = new Date();
        
        // Find the most recent Sunday to align the search
        const day = d.getDay(); 
        const diff = d.getDate() - day; // Adjust to last Sunday
        d.setDate(diff);

        // Loop back 52 weeks (1 year)
        for(let i=0; i<52; i++) {
            // Check Sunday
            potentialFiles.push(`tb_${d.toISOString().split('T')[0]}.csv`);
            
            // Check Saturday (in case TB ended a day early)
            let sat = new Date(d);
            sat.setDate(sat.getDate() - 1);
            potentialFiles.push(`tb_${sat.toISOString().split('T')[0]}.csv`);

            // Move back 1 week
            d.setDate(d.getDate() - 7);
        }

        // Add strict manual checks just in case
        potentialFiles.push("tb_2025-12-28.csv");
        potentialFiles.push("tb_2025-12-8.csv");

        // 2. Check all potential files in parallel (Fast)
        const uniqueFiles = [...new Set(potentialFiles)]; // Remove duplicates
        const foundFiles = [];

        // We use Promise.all to check them all at once instead of waiting for each one
        await Promise.all(uniqueFiles.map(async (file) => {
            try {
                const response = await fetch(file, { method: 'HEAD' });
                if (response.ok) {
                    foundFiles.push(file);
                }
            } catch (e) {
                // Ignore missing files
            }
        }));

        // 3. Update the dropdown
        if (foundFiles.length > 0) {
            foundFiles.sort().reverse(); // Newest dates first
            selector.innerHTML = "";
            foundFiles.forEach((f, i) => {
                // Make the label pretty: "2025-12-28"
                const label = f.replace('tb_','').replace('.csv','') + (i===0 ? " (Latest)" : "");
                selector.add(new Option(label, f));
            });
            
            // Auto-load the newest one
            loadCsvData(foundFiles[0]);
        } else {
            status.innerText = "No CSV files found (Checked last 52 Sundays).";
        }
    }

    function loadCsvData(filename) {
        const status = document.getElementById('status');
        status.innerText = "Loading " + filename + "...";
        
        Papa.parse(filename, {
            download: true,
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: function(results) {
                if (results.data && results.data.length > 0) {
                    processAndRender(results.data, filename);
                } else {
                    status.innerText = "Error: File is empty.";
                }
            },
            error: function(err) {
                status.innerText = "Error parsing CSV.";
                console.error(err);
            }
        });
    }

    function processAndRender(data, filename) {
        document.getElementById('status').innerText = "Viewing: " + filename;
        
        // Filter valid rows
        const cleanData = data.filter(row => row['Name'] || row['Player Name']);

        // Update Chart
        const chartData = [...cleanData].sort((a, b) => (b['Combat Waves'] || 0) - (a['Combat Waves'] || 0)).slice(0, 10);
        renderMainChart(chartData);

        // Update Table
        if (dataTable) dataTable.destroy();
        const body = document.getElementById('tableBody');
        body.innerHTML = '';

        cleanData.forEach((row) => {
            const name = row['Name'] || row['Player Name'] || "Unknown";
            const points = row['Total Territory Points'] || row['Total Points'] || 0;
            const waves = row['Combat Waves'] || 0;
            const platoons = row['Platoon Units'] || 0;
            const avg = (waves / 6).toFixed(1);

            const tr = document.createElement('tr');
            tr.setAttribute('data-child-data', JSON.stringify(row));
            tr.innerHTML = `
                <td class="expand-btn">+</td>
                <td class="fw-bold">${name}</td>
                <td>${points.toLocaleString()}</td>
                <td><span class="badge bg-success">${waves}</span></td>
                <td>${avg}</td>
                <td>${platoons}</td>
            `;
            body.appendChild(tr);
        });

        dataTable = $('#statsTable').DataTable({ order: [[3, 'desc']], pageLength: 25 });

        $('#statsTable tbody').off('click').on('click', 'td.expand-btn', function() {
            const tr = $(this).closest('tr');
            const row = dataTable.row(tr);
            if (row.child.isShown()) {
                row.child.hide();
                $(this).text('+');
            } else {
                const d = JSON.parse(tr.attr('data-child-data'));
                row.child(formatDetails(d)).show();
                $(this).text('-');
            }
        });
    }

    function formatDetails(d) {
        let html = '<div class="p-3"><h6>Phase Breakdown:</h6><div class="d-flex flex-wrap">';
        for (let i = 1; i <= 6; i++) {
            const w = d[`P${i} Waves`] || 0;
            const gp = d[`P${i} Deployed GP`] || 0;
            html += `<div class="phase-box">
                <div class="fw-bold text-primary">Phase ${i}</div>
                <div>Waves: ${w}</div>
                <div class="small">GP: ${gp.toLocaleString()}</div>
            </div>`;
        }
        return html + '</div></div>';
    }

    function renderMainChart(chartData) {
        const ctx = document.getElementById('guildChart').getContext('2d');
        if (mainChart) mainChart.destroy();
        mainChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartData.map(d => d.Name || d['Player Name']),
                datasets: [{
                    label: 'Waves',
                    data: chartData.map(d => d['Combat Waves'] || 0),
                    backgroundColor: '#1a2a6c'
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    // Run the scan
    scanForFiles();
</script>
</body>
</html>
