<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chewbooty Guild Roster</title>
  <style>
    body { font-family: Arial, sans-serif; background:#1c1c1c; color:#f0f0f0; margin:20px; }
    h1 { text-align:center; color:#ffd700; }
    table { width:100%; border-collapse:collapse; margin-top:20px; background:#2a2a2a; }
    th, td { border:1px solid #444; padding:6px 8px; text-align:center; }
    th { background:#333; color:#ffd700; cursor:pointer; position:sticky; top:0; }
    tr:nth-child(even) { background:#242424; }
    tr:hover { background:#3a3a3a; }
    .pos { color:#00ff00; font-weight:bold; }
    .neg { color:#ff4444; font-weight:bold; }
    a { color:#66ccff; text-decoration:none; }
    a:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <h1>Chewbooty Guild Roster</h1>
  <table id="guildTable">
    <thead>
      <tr>
        <th data-col="Name">Player</th>
        <th data-col="AllyCode">SWGOH.gg</th>
        <th data-col="CharacterGP">Character GP</th>
        <th data-col="ShipGP">Ship GP</th>
        <th data-col="TotalGP">Total GP</th>
        <th data-col="LeagueId">League</th>
        <th data-col="SkillRating">Skill Rating</th>
        <th data-col="G13Count">G13</th>
        <th data-col="Relics">Relics</th>
        <th data-col="ZetaCount">Zetas</th>
        <th data-col="OmiCount">Omicrons</th>
        <th data-col="Speed20">Speed ≥20</th>
        <th data-col="Speed25">Speed ≥25</th>
        <th data-col="UltimateGLCount">Ultimate GL</th>
        <th data-col="TotalScore">Total Score</th>
        <th data-col="GearScore">Gear Score</th>
        <th data-col="ModScore">Mod Score</th>
        <th>Net Change (GP)</th>
        <th>Net Change (Total Score)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const FILES = ["ChewbootyOld.csv","Chewbooty.csv"]; // always compare these two

Promise.all(FILES.map(f => fetch(f).then(r=>r.text())))
  .then(([oldCSV,newCSV]) => {
    renderComparison(oldCSV,newCSV);
  });

function parseCSV(csvText) {
  const rows = csvText.trim().split(/\r?\n/).map(r => r.split(','));
  return {header: rows[0], data: rows.slice(1)};
}

function renderComparison(oldText,newText) {
  const old = parseCSV(oldText);
  const newer = parseCSV(newText);

  const colMap = {
    Name: newer.header.indexOf("Name"),
    AllyCode: newer.header.indexOf("AllyCode"),
    CharGP: newer.header.indexOf("CharacterGP"),
    ShipGP: newer.header.indexOf("ShipGP"),
    League: newer.header.indexOf("LeagueId"),
    Skill: newer.header.indexOf("SkillRating"),
    G13: newer.header.indexOf("G13Count"),
    Zetas: newer.header.indexOf("ZetaCount"),
    Omis: newer.header.indexOf("OmiCount"),
    Speed20: newer.header.indexOf("Speed20"),
    Speed25: newer.header.indexOf("Speed25"),
    UltGL: newer.header.indexOf("UltimateGLCount"),
    RelicStart: newer.header.indexOf("Relic1Count"),
    RelicEnd: newer.header.indexOf("Relic9Count"),
    TotalScore: newer.header.indexOf("TotalScore"),
    GearScore: newer.header.indexOf("GearScore"),
    ModScore: newer.header.indexOf("ModScore")
  };

  const tbody = document.querySelector("#guildTable tbody");
  tbody.innerHTML = "";

  newer.data.forEach(row => {
    const totalGP = (+row[colMap.CharGP]||0) + (+row[colMap.ShipGP]||0);
    const relics = row.slice(colMap.RelicStart,colMap.RelicEnd+1)
                      .reduce((sum,v)=>sum+(+v||0),0);

    // find matching player in old file
    const oldRow = old.data.find(r => r[old.header.indexOf("Name")] === row[colMap.Name]);

    let netChangeGP = "";
    let netChangeScore = "";
    if (oldRow) {
      const oldGP = (+oldRow[old.header.indexOf("CharacterGP")]||0) + (+oldRow[old.header.indexOf("ShipGP")]||0);
      const diffGP = totalGP - oldGP;
      netChangeGP = `<span class="${diffGP>=0?'pos':'neg'}">${diffGP>=0?'+':''}${diffGP.toLocaleString()}</span>`;

      const oldScore = +oldRow[old.header.indexOf("TotalScore")]||0;
      const newScore = +row[colMap.TotalScore]||0;
      const diffScore = newScore - oldScore;
      netChangeScore = `<span class="${diffScore>=0?'pos':'neg'}">${diffScore>=0?'+':''}${diffScore.toFixed(2)}</span>`;
    }

    const allyCode = row[colMap.AllyCode];
    const swgohLink = allyCode ? `<a href="https://swgoh.gg/p/${allyCode}/" target="_blank">${allyCode}</a>` : "";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row[colMap.Name]}</td>
      <td>${swgohLink}</td>
      <td>${Number(row[colMap.CharGP]).toLocaleString()}</td>
      <td>${Number(row[colMap.ShipGP]).toLocaleString()}</td>
      <td>${totalGP.toLocaleString()}</td>
      <td>${row[colMap.League]}</td>
      <td>${row[colMap.Skill]}</td>
      <td>${row[colMap.G13]}</td>
      <td>${relics}</td>
      <td>${row[colMap.Zetas]}</td>
      <td>${row[colMap.Omis]}</td>
      <td>${row[colMap.Speed20]}</td>
      <td>${row[colMap.Speed25]}</td>
      <td>${row[colMap.UltGL]}</td>
      <td>${row[colMap.TotalScore]}</td>
      <td>${row[colMap.GearScore]}</td>
      <td>${row[colMap.ModScore]}</td>
      <td>${netChangeGP}</td>
      <td>${netChangeScore}</td>
    `;
    tbody.appendChild(tr);
  });

  makeSortable();
}

function makeSortable() {
  const headers = document.querySelectorAll("th[data-col]");
  headers.forEach(th => {
    th.onclick = () => {
      const col = th.getAttribute("data-col");
      sortTable(col);
    };
  });
}

function sortTable(col) {
  const table = document.getElementById("guildTable");
  const rows = Array.from(table.tBodies[0].rows);
  const idx = Array.from(table.tHead.rows[0].cells).findIndex(c=>c.getAttribute("data-col")===col);

  rows.sort((a,b)=>{
    const valA = a.cells[idx].innerText.replace(/,/g,"");
    const valB = b.cells[idx].innerText.replace(/,/g,"");
    return Number(valB)-Number(valA);
  });

  rows.forEach(r=>table.tBodies[0].appendChild(r));
}
</script>
</body>
</html>
